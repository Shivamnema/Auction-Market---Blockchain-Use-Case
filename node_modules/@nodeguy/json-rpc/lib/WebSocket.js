'use strict'

const I = require('iteray')
const R = require('ramda')
const WebSocket = require('ws')

const webSocketPipe = (socket) =>
  (asyncIterable) => {
    const input = I.to('Iterator', asyncIterable)
    const output = I.AsyncQueue()

    const pull = () => {
      if (socket.readyState === socket.OPEN) {
        input.next().then((result) => {
          if (result.done) {
            socket.close()
          } else {
            socket.send(result.value)
          }

          setImmediate(pull)
        })
      }
    }

    socket.onclose = () => {
      output.push(Promise.resolve({done: true}))
    }

    socket.onerror = (error) => {
      output.push(Promise.reject(error))
    }

    socket.onmessage = (event) => {
      output.push(Promise.resolve({done: false, value: event.data}))
    }

    socket.onopen = pull

    pull()
    return output
  }

module.exports = (url) =>
  R.pipe(
    I.map(JSON.stringify),
    webSocketPipe(new WebSocket(url)),
    I.map(JSON.parse)
  )
