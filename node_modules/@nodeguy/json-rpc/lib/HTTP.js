'use strict'

const httpClient = require('request-promise')
const I = require('iteray')
const R = require('ramda')

const jsonRpcToHttpRequest = (url) =>
  (body) => ({
    body,
    json: true,
    method: 'POST',
    url
  })

const httpToJsonRpcError = (promise) =>
  promise.catch(({error, options: {body: {id}}}) => ({
    error: {
      code: -32300,
      data: error,
      message: String(error)
    },
    id,
    jsonrpc: '2.0'
  }))

module.exports = (url) => R.pipe(
  I.map(R.pipe(
    jsonRpcToHttpRequest(url),
    httpClient,
    httpToJsonRpcError
  )),
  I.pull
)
