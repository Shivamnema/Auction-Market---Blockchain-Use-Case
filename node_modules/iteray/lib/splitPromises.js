'use strict'

const AsyncQueue = require('./AsyncQueue')
const generic = require('@nodeguy/generic')
const is = require('@nodeguy/type').is
const to = require('./to')

const splitPromises = generic.create({name: 'splitPromises'})

splitPromises.method([is('AsyncIterable')],
  (asyncIterable) => {
    const input = to('Iterator', asyncIterable)

    const pull = () =>
      setImmediate(() => {
        input.next().then(
          (value) => {
            values.push(Promise.resolve(value))

            if (value.done) {
              reasons.push(Promise.resolve(value))
            }
          },
          (reason) => {
            reasons.push(Promise.resolve({done: false, value: reason}))
            pull()
          }
        )
      })

    const values = AsyncQueue(pull)
    const reasons = AsyncQueue()
    return {values, reasons}
  }
)

module.exports = splitPromises
